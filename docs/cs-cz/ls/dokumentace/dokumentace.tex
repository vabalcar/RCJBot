\documentclass[12pt, ngerman]{article}

\usepackage[utf8]{inputenc}
\usepackage{geometry}
\usepackage{amsmath}
\usepackage{last page}
\usepackage{fancyhdr}
\usepackage{enumitem}
\usepackage{xcolor}
\usepackage{sectsty}
\usepackage{float}
\usepackage{hyperref}
\usepackage{csquotes}

\MakeOuterQuote{"}

\newcommand{\PROGRAM}{RCJBot}
\newcommand{\PREDMET}{Java}
\newcommand{\AUTOR}{Václav Balcar}

\hypersetup{
    pdfsubject={\PREDMET},
    pdfauthor={\AUTOR},
    pdftitle={\PREDMET\ - \PROGRAM}
}

\definecolor{BackgroundColor}{HTML}{ffffff}
\definecolor{FontColor}{HTML}{152525}
\definecolor{SectionColor}{HTML}{216666}
\definecolor{SubSectionColor}{HTML}{3b8787}
\definecolor{SubSubSectionColor}{HTML}{4aa8a8}

\renewcommand{\contentsname}{Obsah}
\renewcommand{\figurename}{Obr.}

\pagecolor{BackgroundColor}
\color{FontColor}
\sectionfont{\color{SectionColor}}
\subsectionfont{\color{SubSectionColor}}
\subsubsectionfont{\color{SubSubSectionColor}}

\geometry{a4paper, total={190mm, 277mm}, left=20mm, right=20mm, top=20mm, bottom=20mm}
\setlength{\parindent}{0mm}

\title{Dokumentace programu \PROGRAM, zápočtového programu z předmětu \PREDMET}
\date{LS 2017/2018}
\author{\AUTOR, 2. ročník, 31. studijní skupina}

\fancyhf{}
\lhead{Dokumentace}
\rhead{\PROGRAM}
\rfoot{\thepage}
\pagestyle{fancy}

\hypersetup{
    colorlinks=true,
    urlcolor=blue
}

\begin{document}
\pagenumbering{gobble}
\maketitle
\newpage
\pagenumbering{arabic}

\section{Uživatelská dokumentace}
\subsection{Účel}
RCJBot je softwarové řešení dálkového řízení a monitorování mobilního legového robota (postaveného ze stavebnice \href{https://www.lego.com/en-us/mindstorms/products/mindstorms-ev3-31313}{Lego 31313 MINDSTORMS EV3}) přes počítačovou síť pomocí dalšího zařízení.

\subsection{Ovládání}
Softwarové řešení má dvě oddělené části. První je program, který běží v řídící jednotce robota, druhá je program, pomocí kterého je robot ovládán. Obě části jsou navrženy tak, aby byly pro uživatele přívětivé a nevyžadovaly jiné než nezbytné technické znalosti k jejich používání. Program pro ovládání má navíc dvě různé implementace. První je program pro desktopový operační systém (na ten budu dále referovat jako na program pro počítač), druhá aplikace pro Android. Program pro počítač má GUI, program pro robota "text-based user interface" (dále TUI), což je vzhledem k hardwarovým možnostem robota ten nejpohodlnější poskytnutelný způsob interakce s programem v něm běžícím a Androidí aplikace má samozřejmě GUI, obecně se svým vzhledem nijak neliší od běžných Androidích aplikací. Samotné dálkové řízení pak je realizováno pomocí stisků kláves na klávesnici řídícího počítače (mapování kláves na příkazy pro pohyb robota je konfigurovatelné) nebo přes libovolnou metodu řízení v Androidí aplikaci. Monitoring dat z robota v počítači i v Androidu pak vypadá obdobně jako vizualizace dat z parkovacích senzorů v autech.

\subsection{Podporované HW komponenty robota}
Monitorovat a vizualizovat data je možné ze všech senzorů pro Lego Mindstorms EV3 i Lego Mindstorms NXT (předchozí generace Lego Mindstorms). Stejně tak je možné používat motory pro Lego Mindstorms EV3 i Lego Mindstorms NXT. Zkrátka lze používat cokoliv, co podporuje leJOS EV3.

\subsection{Požadavky}
\subsubsection{Na robota}
Program je navržen tak, aby pomocí něj bylo možné přirozeným způsobem ovládat  mobilního robota, který k pohybu využívá diferenciální podvozek. Dále může robot používat dálkoměr na detekci blížící se překážky, dotykový senzor pro detekci nárazu a color senzor pro detekci barvy povrchu, po němž se robot pohybuje. Data z těchto senzorů budou vizualizována výše popsaným způsobem. Ovšem je k dispozici i textová verze monitorování dat z robota, čímž je realizovaná možnost číst data ze všech podporovaných senzorů. Motory, které nejsou využity v rámci podvozku, jde ovládat samostatně a manuálně. Tudíž je možné vybudovat kromě podvozku jakoukoliv další konstrukci využívající motory a řídit ji na dálku.

\subsubsection{Na uživatele}
Na uživatele žádné zvláštní požadavky kladeny nejsou, pouze musí být schopný nainstalovat potřebný software.

\subsubsection{Na systém(y) uživatele}
Pro běh programu pro počítač je třeba mít na něm nainstalované JRE alespoň verze 7.\\\\
Pro běh aplikace pro Android je třeba mít Android alespoň ve verzi 4.0.3 (přesněji Android podporující Android API 15).\\\\ 
Dále musí uživatel zajistit připojení řídící jednotky robota a ovládajícího počítače či Androidího zařízení ke společné počítačové síti, což přináší především požadavek na kompatibilní NIC připojitelné přes USB k robotovi. Neoficiální seznam testovaných podporovaných zařízení je následující:\\

Kompatibilní Wifi NIC:
\begin{enumerate}[leftmargin=5mm]
\item Netgear Wireless-N 150 usb adapter (WNA1100 Chipset)
\item Edimax EW-7811UN micro WiFi dongle
\end{enumerate} 

Kompatibilní Ethernet NIC:
\begin{enumerate}[leftmargin=5mm]
\item Apple USB ethernet adapter
\end{enumerate}

V robotovi je nutné mít nainstalovaný leJOS (lego Java OS), softwarové řešení portování JVM na řídící jednotky robotů Lego Mindstorms mající název leJOS. Konkrétně v tomto případě se je užita "edici" leJOSu s názvem \href{http://www.lejos.org/ev3.php}{leJOS EV3}, což je (jak název napovídá) edice leJOSu pro Lego Mindstorms EV3. Současná verze tohoto systému obsahuje JRE verze 7 a je to právě ta verze, kterou je třeba mít k běhu programu pro robota.

K instalaci leJOSu je třeba mít microSDHC paměťovou kartu s kapacitou 2-32GB. RCJBot nemá žádné zvýšené nároky na velikost perzistentní paměti v robotovi, minimální (co do kapacity) 2GB pamťová karta je plně postačující. Pro více informaci o instalaci leJOSu vizte \href{https://sourceforge.net/p/lejos/wiki/Windows Installation/}{návod na instalaci od vývojářů leJOSu}.

Dále pokud chce uživatel sestavovat a spouštět programy nebo generovat programátorskou dokumentaci pomocí předpřipravených antích skriptů, je třeba mít naistalovaný ant ve verzi alespoň 1.8.0 (ale silně doporučuji používat aktuální verzi, skripty jsou testovány antem ve verzi verzi 1.10.3). Předpokládá se korektní instalace Antu.

A pokud chce uživatel sestavovat a spouštět aplikace pro Android nebo generovat programátorskou dokumentaci z Androidích projektů, je třeba mít nainstalované aktuální Android SDK nebo nejlépe aktuální Android Studio. Doporučuji před aplikací antích skriptů otevřít Androidí projekty v Android Studiu, i když teoreticky by to nemělo být potřeba, nicméně local.properties v Androidích projektech působí poněkud nebezpečně a pravděpodobně budou důvod, proč otevření v Android Studiu může pomoci opravit mnohé komplikace.

Před spuštěním Antích skriptů je dále třeba nastavit položku eclipse.jre v souboru\\
RCJBot/sources/build.properties na cestu k JRE, které není ve verzi 10. Jedná se o obejití nedostatku antí knihovny Ant4Eclipse, která si s Javou 10 zatím nedovede poradit. Dále je třeba nastavit android.sdk.dir v souboru android.properties na cestu k Android SDK.

\subsection{Jak programy sestavit}
K sestavení programů stačí otevřít kořenový adresář zápočtového programu a spustit zde příkaz "ant Export". Pak lze nalézt sestavené programy (kromě Androidí aplikace) v adresáři RCJBot/build vzhledem ke kořenovému adresáři projektu. V této složce je složka pc, ve které je spustitelný jar, po jehož spuštění se otevře program pro počítač. Ve složce build je ještě složka lejos, kde se nachází program pro robota, který nelze bez robota úspěšně spustit. Aplikace pro Android je po dokončení "ant Export" nainstalovaná v připojeném zařízení či emulátoru.

\subsection{Jak programy spustit}
Ke spuštění programů stačí otevřít kořenový adresář zápočtového programu a spustit zde příkaz "ant PCRun", "LejosRun" nebo "AndroidRun", podle toho, který program se má spustit. Dále existuje příkaz "ant RunAll", který spustí všechny programy najednou a paralelně. Před spuštěním jsou všechny všechny spouštěné programy znovu sestaveny. Opětovně lze programy spouštět postupem v "Jak programy sestavit" v případě programu pro počítač nebo pomocí leJOSu nebo Androidu zcela standardním způsobem vzhledem k danému operčnímu systému v případě ostatních komponent zápočtového programu.

\subsection{Jak získat programátorskou dokumentaci}
Pro získání programátorské dokumentace (javadocu) stačí otevřít kořenový adresář zápočtového programu a spustit zde příkaz "ant Javadoc". Vygenerovaná dokumentace se pak nachází v adresáři "docs/javadoc".

\subsection{O testovacím robotovi}
Testovací robot má pásový podvozek a využívá všech senzorů ze setu Lego 31313 Mindstorms EV3. Dále má sestavené motorem ovládané dělo, které je součástí daného Lego setu. Na tomto robotovi je pak možné testovat a prezentovat všechny funkce programu RCJBot.

\subsection{O chování programu - bez uvážení Androidí aplikace}
Můj zápočtový program je dvojicí programů, kdy jeden běží v ovládaném robotovi a druhý na řídícím počítači. Tyto dva programy spolu komunikují přes počítačovou síť. Vzhledem k tomu, že robot je popsatelný pomocí konfiguračního souboru, je zde velká volnost v konkrétní konstrukci robota, jedinou podmínkou je, že robot musí mít diferenciální podvozek. Činnost programu je následující: robot po spuštění získá potřebné informace z konfiguračního souboru, inicializuje HW a vyčká na přípojení řídícího programu. Skrz ten může uživatel po připojení k robotovi ovládat jeho pohyb i pohyb všech připojených motorů pomocí stisků kláves na klávesnici (jakých - záleží na uživateli, ovládání je přizpůsobitelné pomocí konfiguračního okna). Během dálkového řízení jsou data z vybraných sensorů (dálkoměr, touch sensor a color sensor) vizualizována v rámci vlastního UI prvku. Tato vizualizace je podobná vizualizaci dat z parkovacích sensorů v autech. V případě přerušení spojení mezi robotem a řídící aplikací je o této skutečnosti uživatel informován prostřednictvím chybového okna. Následně (případně po odstranění problému) se lze znovu připojit k robotovi. Pokud se klient odpojí od robota, robot počká na připojení (dalšího) klienta. Činnost robota lze v každém okamžiku ukončit stiskem libovolného tlačítka na jeho řídící jednotce. K úplnosti dodávám, že robot a počítač spolu komunikují přes TCP a data, které si posílají, jsou zaserializované objekty. Vyhledání robota v síti je automatické, stačí znát jeho jméno (hostname) a port použitý pro komunikaci.

\subsection{O chování programu - rozšíření o Androidí aplikaci}
Androidí aplikace dokáže plně nahradit (či spíše předčit) aplikaci pro počítač v popisu výše (jelikož se do jisté míry chová anologicky, pouze metodika řízení je odlišná a dále je třeba zvážit jisné fundamentální rozdíli mezi swingovou a Androidí aplikací). Pro více informací o chování Androidí aplikace vizte sekci  "Ovládání aplikace pro Android" a příbuzné sekce.

\subsection{Ovládání programu pro robota}
Ovládání programu pro robota je popsáno výše v sekci "O chování programu".

\subsection{Konfigurace programu pro robota}
Je prováděna přes konfigurační soubory "port.conf" a "robot.conf". Tyto soubory musí být v pracovním adresáři programu a jejich formát je následující:

V souboru port.conf musí být (pouze) číslo portu, který bude použit pro čekání robota na připojení řídícího programu. Tento port musí být volný pro použití TCP a UDP.

Soubor robot.conf musí mít formát, který popisuje následující ukázkový konfigurační soubor:\\

\# konfigurační záznam jednoho sensoru má následující formát:\\
\# sensor type           mode     port readingFrequency\\
\# například:\\
sensor  EV3IRSensor    Distance S1   50\\
sensor  EV3TouchSensor Touch    S3   50\\
sensor  EV3ColorSensor ColorID  S4   50\\

\# konfigurační záznam jednoho kola podvozku a motoru, který ho řídí, mají následující formát:\\
\# wheel motorType              motorPort diameter offset gearRatio invert\\
\# například:\\
wheel  EV3LargeRegulatedMotor A         30       55     4.67      true\\
wheel  EV3LargeRegulatedMotor D         30       -55    4.67      true\\

\# konfigurační záznam ostatních motorů má následující formát:\\
\# motor motorType               motorPort\\
\# například:\\
motor  EV3MediumRegulatedMotor B\\

Tento soubor musí mít LF konce řádků.

\subsection{Ovládání programu pro počítač}
Ovládání programu pro počítač je částečně popsáno výše v sekci "O chování programu". To bych doplnil o to, že po připojení se k robotovi lze robota ovládat stisky kláves, kdy výchozí ovládání je následující:\\

jízda robota vpřed = klávesa (šipka) nahoru\\
jízda robota vzad = klávesa (šipka) dolů\\
jízda robota vlevo = klávesa (šipka) vlevo\\
jízda robota vpravo = klávesa (šipka) vpravo \\
otáčení v podvozku nepoužívaného motoru 1 vpřed = klávesa Q\\
otáčení v podvozku nepoužívaného motoru 1 vzad = klávesa A\\
otáčení v podvozku nepoužívaného motoru 2 vpřed = klávesa W\\
otáčení v podvozku nepoužívaného motoru 2 vzad = klávesa S\\
otáčení v podvozku nepoužívaného motoru 3 vpřed = klávesa E\\
otáčení v podvozku nepoužívaného motoru 3 vzad = klávesa D\\
otáčení v podvozku nepoužívaného motoru 4 vpřed = klávesa R\\
otáčení v podvozku nepoužívaného motoru 4 vzad = klávesa F\\
(očíslování v podvozku nepoužívaných motorů je stejné, jako pořadí, v jakém jsou tyto motory uvedeny v konfiguračním souboru robota)\\

a je možné toto výchozí ovládání změnit pomocí konfiguračního okna, které lze otevřít přes menu $\rightarrow$ Preferences $\rightarrow$ Controls confiuration.\\
Dále pro opětovné připojení se k robotovi je třeba znovu otevřít připojovací okno, které lze otevřít přes menu $\rightarrow$ JBot $\rightarrow$ Connect.\\
Ovládání těchto dialogových oken je intuitivní a není třeba specifického návodu na jejich používání.

\subsection{Konfigurace programu pro počítač}
Je prováděna pomocí postupů v sekci "Ovládání programu pro počítač", externí konfigurace (přes editaci konfiguračního souboru, který si program pro PC sám vytvoří během své činnosti ve svém pracovním adresáři) není doporučena.

\subsection{Ovládání aplikace pro Android}
Ovládání aplikace pro Android je snadné - po spuštění se otevře aktivita, na které uživatel zadá připojovací informace o připojení k robotovi (jeho jméno a číslo portu, který se má v rámci komunikace použít). Poté se spustí poslední uživatelem používaná metoda řízení (pokud taková metoda existuje) a uživatel může začít ovládat robota. Případně může změnit metodu řízení pomocí bočního šuplíkového menu. Mezi metodami řízení lze přecházet libolně bez přerušení spojení s robotem. Metody řízení je možné i procházet bez připojeného robota. Poté, co si uživatel bude přát ukončit aktivní spojení s robotem nebo spojení navázat (neexistuje-li), slouží pro tento účel tlačítko na toolbaru aplikace.

\subsection{Existující metody řízen v aplikaci pro Android}
\subsubsection{Button control}
Ovládání robota pomocí stisků tlačítek na displayi.
\subsubsection{Accel control}
Ovládání robota pomocí náklonu zařízení s Androidem. Obecně platí, že čím větší náklon, tím vyšší rychlost. Robot pak vykonává pohyb ve směru náklonu zařízení. K používání této metody řízení je třeba mít v zařízní s Androidem gravitační sensor. Dále je tu přidaná položka do menu v toolbaru umožňující volbu akce motoru. Po zvolení čísla konkrétního motoru a směru pohybu se pak v aktivitě objeví tlačítko, při jehož stisku robot provádí otáčení v podvozku nepoužívaného motoru se zvoleným číslem ve zvoleném směru (čili provádí požadovanou akci motoru).
\subsubsection{Joystick control}
Ovládání robota pomocí virtuálního joysticku. Pro ovládání pak platí analogická logika jako při ovládání pomocí nákonu zařízení. V této metodě řízení je dále obsažena stejná možnost provádět vybranou akci v podvozku nepoužívaného motoru jako v metodě "Accel control".
\subsubsection{Vizualizér dat}
V každé výše zmíněné metodě řízení je také (nepřehlédnutelný) vizualizér dat. Jedná se o portovaný vizualizér z aplikace pro počítač.

\subsection{Konfigurace aplikace pro Android}
Je prováděna pomocí postupů v sekci "Ovládání aplikace pro Android" s tím, že kdykoliv uživatel provede nějaký výběr, je jeho volba automaticky uložena, aniž by o tom věděl, a při dalším spuštění aplikace je tato volba již automaticky provedena.
\end{document}
